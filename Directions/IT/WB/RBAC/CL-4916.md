Какие проблемы мы хотим решить:
Возможны случаи, когда у пользователя валидный токен, т.к. длиный ttl, но он уже удален как админ из Gandalf-а - https://band.wb.ru/wbcloud/pl/cp6he1aw1jyk5ksy1xa7cqxawe
Если мы используем дефенишн gandalf_account, то было бы хорошо, что бы группы админов были как-то с ним связаны. Сейчас наличие или отсутсвие пользователя в gandalf_account ни на что не влияет.
Сейчас есть несколько варинтов работы с правами в Gandalf:
Вариант 1
Обсудили, что нам не нужно иметь возможность предоставлять доступ к конкретному аккаунту.
В свзяи с этим стоит удалить gandalf_account из схемы SpiceDB.
Оставить 2 роли - для управления аккаунтами и просмотр.
Также следует перенести пермишены из gandalf_account в cloud
Вариант 2
У нас появится раздел в админке (Octopus) по управлению пользователями в Gandalf. Это не только создание / удаление пользователей. Но и управление их группами.
Напмоню - групп у одного пользователя может быть несколько, в отличии от ролей. Роль - только одна. Как это реализовано? По сути это релейшены, если мы говорим про админов, то это релейшены между user и cloud.
Что меня смущает в текущей схеме?
Что в user находятся не только админы, но и обычные пользователи.
Удаление аккаунта в gandalf не влияет на удаление релейшенов в SpiceDB.
Что если нам сделать привязку релейшенов не user - cloud, а gandalf_account - cloud? И к gandalf_accont уже привязывать user.
Что нам это дает?
Прозрачность разделения обычных пользователей и админов. Т.е. мы случайно не привяжем обычному пользователю права админа, т.к. это все делается черезе gandalf_account.
Прозрачность создания и удаление админов - это будет делаться при создании и удалении аккаунта в Gandalf.

```
![rochev.vladimir5 profile image](https://band.wb.ru/api/v4/users/6t9siksgm7grzq3qwmzzumuwia/image?_=1721905154730)

Владимир Рочев

[05/30/2025 at 2:50 PM](https://band.wb.ru/wbcloud/pl/cp6he1aw1jyk5ksy1xa7cqxawe)

@Александр Сизов такой вот вопрос по Гендальфу

Понятно, что Гендальф обращается к toex за информацией, валидный ли токен

Но что делать, если у нас будет отн-но большой TTL для внешнего токена, а в этот период мы удалим пользователя?Фактически токен имеется, но пользователя уже нет.

Мы будет как-то доп-но валидировать, что на каждый наш запрос пользователь реально есть в базе или доверимся TTL'у токена?

Косвенно затрагивается моим предложением из этого коммента [https://gitlab-private.wildberries.ru/cloud/gandalf/-/merge_requests/37#note_244362](https://gitlab-private.wildberries.ru/cloud/gandalf/-/merge_requests/37#note_244362) Edited

4 replies

![sizov.aleksandr4 profile image](https://band.wb.ru/api/v4/users/6ppofrj1kj8wtm4nonuqpwp8fc/image?_=1738928085805)

Александр Сизов

[05/30/2025 at 3:10 PM](https://band.wb.ru/wbcloud/pl/rt4dpc7mwbdidgqyumcfjtou9h)

Хороший вопрос, нужно подумать.

![rochev.vladimir5 profile image](https://band.wb.ru/api/v4/users/6t9siksgm7grzq3qwmzzumuwia/image?_=1721905154730)

Владимир Рочев

[05/30/2025 at 3:11 PM](https://band.wb.ru/wbcloud/pl/y4mxaryqj7ry3ryxry4jwrh13r)

Понятно, что можно кеш добавить и инвалидировать его при удалении пользователя, чтобы не обращаться каждый раз к БД

![sizov.aleksandr4 profile image](https://band.wb.ru/api/v4/users/6ppofrj1kj8wtm4nonuqpwp8fc/image?_=1738928085805)

Александр Сизов

[06/02/2025 at 1:32 PM](https://band.wb.ru/wbcloud/pl/aq8o3sfdsfnuxg93jd6cap3irr)

Выглядит так, что все будет зависеть от того как мы реализуем проверку прав.

[https://band.wb.ru/wbcloud/pl/oagbq67z37bc8cziwtyx4sdrxa](https://band.wb.ru/wbcloud/pl/oagbq67z37bc8cziwtyx4sdrxa)

![sizov.aleksandr4 profile image](https://band.wb.ru/api/v4/users/6ppofrj1kj8wtm4nonuqpwp8fc/image?_=0)

Александр Сизов

4 days ago at 5:45 PM

Мы сегодня обсуждали удаление дефенишена gandalf_account. Стоит ли это делать?

У нас появится раздел в админке (Octopus) по управлению пользователями в Gandalf. Это не только создание / удаление пользователей. Но и управление их группами.

Напмоню - групп у одного пользователя может быть несколько, в отличии от ролей. Роль - только одна. Как это реализовано? По сути это релейшены, если мы говорим про админов, то это релейшены между user и cloud.

Что меня смущает в текущей схеме?

- Что в user находятся не только админы, но и обычные пользователи.
- Удаление аккаунта в gandalf не влияет на удаление релейшенов в SpiceDB.

Что если нам сделать привязку релейшенов не user - cloud, а gandalf_account - cloud? И к gandalf_accont уже привязывать user.

Что нам это дает?

- Прозрачность разделения обычных пользователей и админов. Т.е. мы случайно не привяжем обычному пользователю права админа, т.к. это все делается черезе gandalf_account.
- Прозрачность создания и удаление админов - это будет делаться при создании и удалении аккаунта в Gandalf.

Edited

Show more

[1:35 PM](https://band.wb.ru/wbcloud/pl/i3p9rhsqy3d3tnogchgeokbafe)

Если у нас будет отдельный дефенишн gandalf_account в SpiceDB и он будет привязан к пользователям, тогда при выполнениии любого действия снчала будет проверка в SpiceDB, что пользователь имеет определенные права.

Когда же мы удаляем пользователя, то первым делом нужно будет удялть связь из SpiceDB, и только потом данные из Gandalf-а.

Тогда, даже если к нам прийдет валидный токен, но пользователь уже удален из SpiceDB, то проверку прав он не пройдет.

![](https://band.wb.ru/static/emoji/1f44d.png)1
```