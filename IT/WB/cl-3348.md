# Test spicedb integration in MR env
#### Deploy spicedb in pipeline if it set to manual deploy.
#### Swap integration mode:
```
Index: internal/vmcontroller/api/config.go
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/internal/vmcontroller/api/config.go b/internal/vmcontroller/api/config.go
--- a/internal/vmcontroller/api/config.go	(revision 3a59ece9fd3f1dd63ec4cf39953abae81a7348e0)
+++ b/internal/vmcontroller/api/config.go	(date 1734604892638)
@@ -88,7 +88,7 @@
 			generatedv2pub.GetInfoServiceForApi(v2pubExtractor),
 		},
 		builders.WithClientTimeout(c.Authorization.SpiceDBTimeout),
-		builders.WithIntegrationMode(builders.FullIntegrationMode),
+		builders.WithIntegrationMode(builders.DisableIntegrationMode),
 		builders.WithDefaultKeysloaderConfig(c.Authorization.JwtPublicKeyPath),
 	)
 	if err != nil {
   ```
#### Build new vmcontroller and copy to MR
```
$ make build
tsh scp -r target  aleksander.rykalin@cloud-runner-3.el.wb.ru:/tmp/
cloud-runner$ scp -r /tmp/target c1-az1.az1.n-cl-3348-spicedb-test-permissions-checks-5.mr.cloud.devel:
cloud-runner$ ssh c1-az1.az1.n-cl-3348-spicedb-test-permissions-checks-5.mr.cloud.devel
root@c1-az1:~#systemctl stop vmcontroller.service
root@c1-az1:~#cp target/vmcontroller /opt/cloud/vmcontroller
```
#### Install local public key on spicedb and vmcontroller
```
root@c1-az1:~#vim /opt/spicedb/ssl/jwt_provider.pem 
root@c1-az1:~#docker exec -it rbac_interceptor_spicedb bash
app#apt-get update
app#apt-get install vim
app#vim /etc/jwt_provider.pem
```

#### restart docker and vmcontroller
```
root@c1-az1:~#systemctl start vmcontroller.service
root@c1-az1:~#docker restart rbac_interceptor_spicedb
```
#### test with vmctl
remove additional instqances from  /etc/cloud/vmctl.yml (leanve only 172.30.12.2)
```
export JWT_TOKEN=...
vmctl -j $JWT_TOKEN create namespace -n spicedb-ns-1
```

## Keys
##### Public key
source - /home/arykalin/go/src/git.wildberries.ru/cloud/local-configs/jwt/jwtRS256.key.pub
```
-----BEGIN PUBLIC KEY-----
MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxC+d9DSdI0hTNo30J9/+
0EEAfTmDjKSxEICEsEIeTImH8t8dEAEl3nQUzuWvY79P0ESjFnJroUd0z1hOfCsE
UF+tN+Z8XiUZrgikNBdtIVVDA0SXzlLiyY93w4uqAfOK78BgqErw1mOWqvUcvvoO
7oZL/MNeEArIRGBMsSG8Tqhii3c9lz8uo9U6GvsH39fWAc6/kybRwQZ2ubmFg+82
ZkhjZuRudlPm0WlKE31AJZQMQByP8JC73mge++bRtHfNuPg835KYD5153Z5FBbsk
u3wA8ZDCsQUhVzL75INzcdjeQjEMQ4zLQirotO4j8An74suT8CIl2a7w7AewP0s+
cC9PFM3GqDweNJ4FjD4Q+TSWrHPw8CNgbyDkywHqw3k+I3NHntmTPx0U06hyLDyi
/PwepfgiSF44Ts6GyyubkvywMgkbyYexufAn765u8Y412gFJZH1iAxlD2cgDoa18
yhhtY4TL+lPZujGEChxieNCnHbQ/QQKtKnMh/YJ/p/GWyoE6Pnq7Y65FuEV3jsp2
9asTZMV6ifzd3/a1eXvnxkHzxXZz3OtlBAzPE1qIsiyacfMqMhwr9QqD+famfBiB
srMIRB15EYS9mdEGDrpJS3ngqqOWRTiR8nRypQpqny01vM/ksDfu9vmmp5aAlH/P
GTZGcFDItVUKE0bqk3aqSEMCAwEAAQ==
-----END PUBLIC KEY-----

```
##### JWT token (till 2030)
```
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyNTY3IiwiZXhwIjoxODkyMjgwMDMzLCJwdWJsaWNfa2V5X2lkIjoiU0hBMjU2OndUTTB1VkZ5dHNWMHl3eUthaFFVcEhlT0tmS0dJS09LY2xXNU15d1d5ZGsiLCJpc19zZXJ2aWNlIjpmYWxzZX0.w-SzkZqILefm65ZtzzoEFb-MEIyGfJtAZPjH-roXj_rpJLa9fbUnjlOhq-zfkm1a8-6u1-Jtptdg1wK3BsmXNdkp4QjssMPhXBebxQnQ-R1Ng5XdjpacqDnCMvff6G9YMOisP4m1dD-_JYmFxMZMX55Oe2WlWP_WVTEJBKsTwHsNCgitBeyq2rh9qvvlLxDwfT-xtdRtkhV5EV3lugOWstUCrkcr-lYiTaUMIqlKt21yUASY_Og-M66RhhYLHOH8HXtLD_nHBxwPdkLiKLXUFMOYfwdJrhHM9ecRqkGM74jVgvVG_edVl3ASBH3XGO17mpi2JKZ4ZBZvRt3mc68WZa2UH7R9AvlstJOB5flU6EwX6k2zxDj-G-uTqFuzD1a1YPVohR8RFBIIEW2mNsdTnk4smqFoEPtmxHuGW4OHKGH2Qr_EHc7_NPuci22Y-ejZ66_DKbp4gsF6aXhQm9SxRKRL5zuu2qsEjWGN9Dd-rzSXyFXaaK8a3dtKBwcFJLCdzkEfbqhDMOAaHXTOhknihBJiMxjSeVu4J12nxpjO7Zeyc5dBMGjyhhTbLr4vs5f2IHD96KwXAxSu_4mG_fCs8hJpyRhGslCb4-UdLonew3TK74blUOQrKAVA112KW-UMINirzPFjSmxhfGPMpFcs5pN8zW8rpkwS3_B_EGxJyYU
```


# Notes

```
tsh scp -r target  aleksander.rykalin@cloud-runner-3.el.wb.ru:/tmp/
cloud-runner-3.el.wb.ru$ scp -r /tmp/target c1-az1.az1.n-cl-3348-spicedb-test-permissions-checks-5.mr.cloud.devel:
cloud-runner-3.el.wb.ru$ ssh c1-az1.az1.n-cl-3348-spicedb-test-permissions-checks-5.mr.cloud.devel
#systemctl stop vmcontroller.service
#cp target/vmcontroller /opt/cloud/vmcontroller
#systemctl restart vmcontroller.service
root@c1-az1:~#vmctl -j eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyNTY3IiwiZXhwIjoxODkyMTk3Nzc2LCJwdWJsaWNfa2V5X2lkIjoiU0hBMjU2OndUTTB1VkZ5dHNWMHl3eUthaFFVcEhlT0tmS0dJS09LY2xXNU15d1d5ZGsiLCJpc19zZXJ2aWNlIjpmYWxzZX0.nSIPZnjtxG0Dcr1YwsgkUKaq-a6aKJz6YwGkq4iPNLQFAOQj3d5RSxEXwMJfGCMZ9RVusLeKAY0l64J36O8yZ5qPjx8QyCA68Zmm901yblBOCm9q2EZ07ZpSm16krqdSdKKk2cwOK5fgnf5r15N1WsNtM8qyHh7w-dlvlujdXIwZjnecVYGteAhV6hT-E33uG2OfL5TZKoQR9YUajNlMrazlKGeSAIoSV1e9wQMi1Dc2rg7AXUakvMyAuzS_c0cYNRjDbB3uG5hCib5eDK2Pf9qMuxs9Bmky8R-onsO7cygfg2kDtcNHnsYVhX3vN7mMlTuRRPm2zwkuLX2UhREl4PBdKrdWlTpnvodNKVam9ibSfb7C9PDDkYI4ubpP3bfRr2YjXsTmFq-AEHsZv2MkdCj7zH5gTSGpFY9KXTaOeqw9vyXh6EhsZbLgkfMi7BVQ349p-TBDWudj8r3D9vG-71jLxRCjdNKj1JsBnMPc-nSMMCb1lvd6QTvtXeSYs6UdzMwNw7E4O_B0T9Pv5Pb3hvK1umaTyVv9h8mYp8RDCduS8CRPH0EbEwjShUKNvvkyFi8ha-zmUqaQesuEOfX4Wg6z7SYOkk4Ecr6_z8bFCioN1-u0ZyftuuwAm_X2qHpr16QCpYg2cV74MCGNI0xGKaI0YnHxpWY5huLFvkhKEyQ create namespace -n nsf1
Usage:
  vmctl create namespace [flags]

Aliases:
  namespace, ns

Flags:
  -h, --help               help for namespace
  -n, --namespace string   namespace name: string

[FATAL] failed to execute: "rpc error: code = Unavailable desc = failed to check permission [cloud:cl0#create_namespace@user:user567]: rpc error: code = Unavailable desc = last connection error: connection error: desc = \"error reading server preface: read tcp 127.0.0.1:49480->127.0.0.1:50052: read: connection reset by peer\""
root@c1-az1:~# 
root@c1-az1:~#docker exec rbac_interceptor_spicedb printenv
```
Debug:
```
c1# docker exec -it rbac_interceptor_spicedb bash
#export ZED_KEYRING_PASSWORD=123
#zed context set admin localhost:50053 ""
#zed relationship read namespace --insecure
```
Install pem on spicedb and vmcontroller:
source - /home/arykalin/go/src/git.wildberries.ru/cloud/local-configs/jwt/jwtRS256.key.pub
```
root@c1-az1:~#vim /opt/spicedb/ssl/jwt_provider.pem 
docker exec -it rbac_interceptor_spicedb bash
apt-get update
apt-get install vim
vim /etc/jwt_provider.pem
```
jwt key:
```
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyNTY3IiwiZXhwIjoxODkyMjgwMDMzLCJwdWJsaWNfa2V5X2lkIjoiU0hBMjU2OndUTTB1VkZ5dHNWMHl3eUthaFFVcEhlT0tmS0dJS09LY2xXNU15d1d5ZGsiLCJpc19zZXJ2aWNlIjpmYWxzZX0.w-SzkZqILefm65ZtzzoEFb-MEIyGfJtAZPjH-roXj_rpJLa9fbUnjlOhq-zfkm1a8-6u1-Jtptdg1wK3BsmXNdkp4QjssMPhXBebxQnQ-R1Ng5XdjpacqDnCMvff6G9YMOisP4m1dD-_JYmFxMZMX55Oe2WlWP_WVTEJBKsTwHsNCgitBeyq2rh9qvvlLxDwfT-xtdRtkhV5EV3lugOWstUCrkcr-lYiTaUMIqlKt21yUASY_Og-M66RhhYLHOH8HXtLD_nHBxwPdkLiKLXUFMOYfwdJrhHM9ecRqkGM74jVgvVG_edVl3ASBH3XGO17mpi2JKZ4ZBZvRt3mc68WZa2UH7R9AvlstJOB5flU6EwX6k2zxDj-G-uTqFuzD1a1YPVohR8RFBIIEW2mNsdTnk4smqFoEPtmxHuGW4OHKGH2Qr_EHc7_NPuci22Y-ejZ66_DKbp4gsF6aXhQm9SxRKRL5zuu2qsEjWGN9Dd-rzSXyFXaaK8a3dtKBwcFJLCdzkEfbqhDMOAaHXTOhknihBJiMxjSeVu4J12nxpjO7Zeyc5dBMGjyhhTbLr4vs5f2IHD96KwXAxSu_4mG_fCs8hJpyRhGslCb4-UdLonew3TK74blUOQrKAVA112KW-UMINirzPFjSmxhfGPMpFcs5pN8zW8rpkwS3_B_EGxJyYU
```

