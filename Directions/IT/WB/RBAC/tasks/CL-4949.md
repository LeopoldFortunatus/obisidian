# vmcontroller error reading server preface: EOF
Error:
```
[FATAL] failed to execute: "rpc error: code = Unknown desc = failed to create namespace relation: failed to create relationship [[{ResourceType:namespace ResourceID:162b8ecaea9d5f2768bdcc96bf8fdcbe925ff238ba39769ff264929b513cdd66 Relation:cloud SubjectType:cloud SubjectID:cl0}]]: failed to add relation - {namespace 162b8ecaea9d5f2768bdcc96bf8fdcbe925ff238ba39769ff264929b513cdd66 cloud cloud cl0}: rpc error: code = Unavailable desc = last connection error: connection error: desc = \"error reading server preface: EOF\""

```

## vmcontroller config
```
authorization:
  spicedb:
    addresses: 172.31.105.2:50052
    client_timeout: 10s
    tls:
      enabled: True
      key_file: "/opt/spicedb/ssl/spicedb_vmcontroller.key"
      cert_file: "/opt/spicedb/ssl/spicedb_vmcontroller.crt"
      ca_cert_file: "/opt/spicedb/ssl/spicedb-ca.crt"
  token_exchange:
    addresses: 172.31.105.2:1024
    client_timeout: 10s
    tls:
      enabled: True
      key_file: "/opt/token-exchange/ssl/token_exchange_vmcontroller.key"
      cert_file: "/opt/token-exchange/ssl/token_exchange_vmcontroller.crt"
      ca_cert_file: "/opt/token-exchange/ssl/token_exchange-ca.crt"

```

## spicedb config
```
SPICEDB_TOKEN_EXCHANGE_ADDRESSES=172.31.105.2:1024:1024
SPICEDB_TOKEN_EXCHANGE_CLIENT_TIMEOUT=15s
SPICEDB_TOKEN_EXCHANGE_ENABLED_TLS=true
TLS_ENABLED=true
SPICEDB_TLS_ENABLED=true
SPICEDB_TLS_CA_CERT_FILEPATH=/etc/ssl/spicedb-ca.crt
SPICEDB_TLS_SERVER_CERT_FILEPATH=/etc/ssl/spicedb.crt
SPICEDB_TLS_SERVER_KEY_FILEPATH=/etc/ssl/spicedb.key
SPICEDB_TLS_CLIENT_CERT_FILEPATH=/etc/ssl/spicedb_client.crt
SPICEDB_TLS_CLIENT_KEY_FILEPATH=/etc/ssl/spicedb_client.key
SPICEDB_TOKEN_EXCHANGE_TLS_CA_CERT_FILEPATH=/etc/token_exchange-cachain.crt
SPICEDB_TOKEN_EXCHANGE_TLS_CLIENT_CERT_FILEPATH=/etc/token_exchange_spicedb.crt
SPICEDB_TOKEN_EXCHANGE_TLS_CLIENT_KEY_FILEPATH=/etc/token_exchange_spicedb.key
SPICEDB_TELEMETRY_ADDRESS=tempo:4317
SPICEDB_TELEMETRY_METER_INTERVAL=60s
SPICEDB_TELEMETRY_TRACE_TIMEOUT=5s
SPICEDB_TELEMETRY_IS_USE_PROMETHEUS_METER=true
SPICEDB_METRICS_ADDRESS=0.0.0.0:50054
SPICEDB_METRICS_READ_TIMEOUT=30s
SPICEDB_METRICS_WRITE_TIMEOUT=60s
SPICEDB_METRICS_IDLE_TIMEOUT=60s
SPICEDB_METRICS_CRT_FILEPATH=
SPICEDB_LOG_LEVEL=debug
SPICEDB_LOG_JSON_OUTPUT=true
SPICEDB_CONNECTION=postgres://spicedb@172.31.105.2:5445/spicedb
SPICEDB_ADDRESS=0.0.0.0:50052
SPICEDB_ADMIN_ADDRESS=0.0.0.0:50053
SPICEDB_CLIENT_TIMEOUT=300ms
SPICEDB_READ_RESOURCE_TIMEOUT=5s
SPICEDB_SCOPE_CONFIG_FILE=./config/scope/scope_config.yaml
SPICEDB_SERVICE_NAME=rbac-interceptor-spicedb
SPICEDB_MIGRATE_DB=true
SPICECTL_SCHEMA_FILE=

```

## test commands
### connect
```
openssl s_client \
  -connect 172.31.105.2:50052 \
  -cert /opt/spicedb/ssl/spicedb_vmcontroller.crt \
  -key /opt/spicedb/ssl/spicedb_vmcontroller.key \
  -CAfile /opt/spicedb/ssl/spicedb-ca.crt \
  -showcerts

```

```
root@c1-az1:~# grpcurl -insecure -cert /opt/spicedb/ssl/spicedb_vmcontroller.crt -key /opt/spicedb/ssl/spicedb_vmcontroller.key -cacert /opt/spicedb/ssl/spicedb-ca.crt 172.31.105.2:50052 list
authzed.api.v1.ExperimentalService
authzed.api.v1.PermissionsService
authzed.api.v1.SchemaService
grpc.health.v1.Health
grpc.reflection.v1.ServerReflection
grpc.reflection.v1alpha.ServerReflection
```
#### netcat check 
##### from host
```
root@c1-az1:~# nc -zv 172.31.105.2 50052
Connection to 172.31.105.2 50052 port [tcp/*] succeeded!
root@c1-az1:~# 
```
##### from docker
```
root@c1-az1:~# docker exec rbac_interceptor_spicedb nc -zv 172.31.105.2 50052
c1-az1.az1.g-cl-4949-gw-rbac-1.mr.cloud.devel [172.31.105.2] 50052 (?) open
root@c1-az1:~# 
```

### files
#### **Сравните сертификаты на хосте и в контейнере**
```
root@c1-az1:~# docker exec rbac_interceptor_spicedb openssl x509 -fingerprint -sha256 -in /etc/ssl/spicedb.crt -noout
sha256 Fingerprint=41:68:C6:38:07:41:90:B7:80:FD:FF:A3:97:A4:2C:58:5B:3D:BD:B9:F1:39:37:B3:D6:B4:B7:8D:D9:27:2E:39
root@c1-az1:~# openssl x509 -fingerprint -sha256 -in /opt/spicedb/ssl/spicedb.crt -noout
SHA256 Fingerprint=41:68:C6:38:07:41:90:B7:80:FD:FF:A3:97:A4:2C:58:5B:3D:BD:B9:F1:39:37:B3:D6:B4:B7:8D:D9:27:2E:39
root@c1-az1:~# 
```
#### check mounts
```
root@c1-az1:~# docker inspect rbac_interceptor_spicedb | grep -A 10 Mounts
        "Mounts": [
            {
                "Type": "bind",
                "Source": "/opt/spicedb/ssl",
                "Destination": "/etc/ssl",
                "Mode": "rw",
                "RW": true,
                "Propagation": "rprivate"
            },
            {
                "Type": "bind",
root@c1-az1:~# 

```

```
root@c1-az1:~# docker exec rbac_interceptor_spicedb ls -la /etc/ssl/
total 100
drwxr-xr-x 3 root root 4096 Jun 30 10:16 .
drwxr-xr-x 1 root root 4096 Jun 30 10:12 ..
-rw-r--r-- 1 root root  624 Jun 30 10:16 jwt_provider.pem
drwxr-xr-x 2  999 root 4096 Jun 30 10:12 root.crt
-r--r--r-- 1 1001 root 2316 Jun 30 10:10 spicedb-ca.crt
-r--r--r-- 1 1001 root 2316 Jun 30 10:10 spicedb-cachain.crt
-r--r--r-- 1 1001 root 2280 Jun 30 10:13 spicedb.crt
-r-------- 1 root root  993 Jun 30 10:12 spicedb.crt.revoke
-rw-r--r-- 1 root root 1119 Jun 30 10:12 spicedb.csr
-r-------- 1 1001 root 3243 Jun 30 10:13 spicedb.key
-r--r--r-- 1 1002 root 2316 Jun 30 10:10 spicedb_client-ca.crt
-r--r--r-- 1 1002 root 2316 Jun 30 10:10 spicedb_client-cachain.crt
-r--r--r-- 1 1002 root 2280 Jun 30 10:11 spicedb_client.crt
-r-------- 1 root root 2280 Jun 30 10:10 spicedb_client.crt.revoke
-r-------- 1 1002 root 3243 Jun 30 10:11 spicedb_client.key
-r--r--r-- 1 1003 root 2316 Jun 30 10:10 spicedb_gateway-ca.crt
-r--r--r-- 1 1003 root 2316 Jun 30 10:10 spicedb_gateway-cachain.crt
-r--r--r-- 1 1003 root 2280 Jun 30 10:11 spicedb_gateway.crt
-r-------- 1 root root 2280 Jun 30 10:10 spicedb_gateway.crt.revoke
-r-------- 1 1003 root 3243 Jun 30 10:11 spicedb_gateway.key
-r--r--r-- 1 1004 root 2316 Jun 30 10:11 spicedb_vmcontroller-ca.crt
-r--r--r-- 1 1004 root 2316 Jun 30 10:11 spicedb_vmcontroller-cachain.crt
-r--r--r-- 1 1004 root 2280 Jun 30 10:12 spicedb_vmcontroller.crt
-r-------- 1 root root 2280 Jun 30 10:11 spicedb_vmcontroller.crt.revoke
-r-------- 1 1004 root 3243 Jun 30 10:12 spicedb_vmcontroller.key
root@c1-az1:~# 

```
### network
```
# docker inspect rbac_interceptor_spicedb --format '{{range .NetworkSettings.Networks}}{{.NetworkID}}{{end}}'
2eb71eaa81e3454d236ba60bc9351a19dc41d6777175f4ac1d4ffc3d181284ea
root@c1-az1:~# docker network inspect 2eb71eaa81e3454d236ba60bc9351a19dc41d6777175f4ac1d4ffc3d181284ea                                                                            [19/494]
[                                                                                                        
    {                                                                                              
        "Name": "bridge",                                                                                                                                                                 
        "Id": "2eb71eaa81e3454d236ba60bc9351a19dc41d6777175f4ac1d4ffc3d181284ea",
        "Created": "2025-06-30T10:11:09.129715392Z",
        "Scope": "local",        
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {   
            "Driver": "default",                                                             
            "Options": null,                                                                 
            "Config": [                                                                      
                {                                                                            
                    "Subnet": "172.17.0.0/24",          
                    "Gateway": "172.17.0.1"                                                  
                }
            ]       
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "5dfd61c25e25286bef66e5051f9572c3308eff94a0d3f4076e9789a27dee9f7d": {
                "Name": "rbac_interceptor_spicedb",
                "EndpointID": "df42de55b195e8def19e1f69aa7753d210e40d6c3baa314ca821a67aed531e67",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/24",
                "IPv6Address": ""
            },
            "7bd848fef2ec2982bd1ace7b8416754fd72b7562f2494edd5c26ff3cb276d3f8": {
                "Name": "spicedb",
                "EndpointID": "91a762b37d41ac7dc0f608cd742cdf5ac1cce0301153f1f45d324ef75a7e6263",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/24",
                "IPv6Address": ""
            },
            "d797a35030847f5127ec523924f9a247e8fb49096176b01653172eedad072b91": {
              "Name": "token-exchangedb",
                "EndpointID": "aaaa901bb96610bff5584533e0a5412a2f2f94d9122393da6ad77b6d006eaddf",
                "MacAddress": "02:42:ac:11:00:04",
                "IPv4Address": "172.17.0.4/24",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]
```
